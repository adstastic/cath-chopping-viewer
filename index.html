<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <title>CATH: PDB Chopping Viewer</title>
</head>
<body>
  <!-- ========= -->
  <!-- Your HTML -->
  <!-- ========= -->

  <!-- ========= -->
  <!-- Libraries -->
  <!-- ========= -->
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone-localstorage.js/1.0/backbone.localStorage-min.js" type="text/javascript"></script>  

<!-- Latest compiled and minified CSS
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
-->

<!-- Optional theme -->
<link rel="stylesheet" href="https://bootswatch.com/lumen/bootstrap.min.css">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>


  <script type='text/javascript' src='./bio-pv-1.5.0/bio-pv.min.js'></script>
  


<style>
#viewer-container {
}
</style>

  <div id="pv-container"></div>

  <div class="container">
  	<div class="page-header">
  		<h1>CATH Chopping Viewer</h1>
	</div>

  	<div class="row">
  		<div class="col-md-8">
  			<div class="panel panel-default">
	  			<div class="panel-heading">
	  				3D Structure
	  			</div>
	  			<div class="panel-body">
					<div id="viewer-container"></div>
	  			</div>
  			</div>
  		</div>
  		<div class="col-md-4">
  			<div class="panel panel-default">
	  			<div class="panel-heading">
	  				Info
	  			</div>
	  			<div class="panel-body">
  					<div id="viewer-info-container">
  					</div> 
  				</div>
  			</div>
  			<div class="panel panel-default">
	  			<div class="panel-heading">
	  				Options
	  			</div>
	  			<div class="panel-body">
  					<div id="viewer-options-container"></div> 
  				</div>
  			</div>
  		</div>
  	</div>
  	<div id="sequence-container"></div>
  </div>

<script type="text/template" id="select-colour-by-template">
<select id="select-colour-by">
<% app.colourByList.each(function(c) { %>
	<option value="<%= c.pvName %>"><%= c.label %></option>
<% }); %>
</select>
</script>



  <!-- =============== -->
  <!-- Javascript code -->
  <!-- =============== -->
  <script type="text/javascript">

	var pvOpts = {
		width: 'auto',
		height: 600,
		antialias: true,
		quality: 'medium'
	};

	var app = {};

	var domainColors = ['blue', 'red', 'green', 'yellow'];

	app.Pdb = Backbone.Model.extend({
		urlRoot: "http://www.biochem.ucl.ac.uk/~ucbcisi/pv-chopping/pdb",
		default: {
			pdbId: '',
			title: '',
			pvStructure: null,
		},
		load: function( pdbId, callback ) {
			var url = this.urlRoot + '/' + pdbId + '.pdb';
			var self = this;

			console.log( "pdb.load", pdbId, url);

			self.set({
				'pdbId': pdbId,
				'title': "PDB " + pdbId
			});

			$.ajax( url )
				.done(function(data) {
					var structure = pv.io.pdb( data );

					self.set({ 
						'pvStructure': structure,
					});

					if ( callback ) { 
						callback( structure );
					}					
				});
		},
	});

	app.ColourBy = Backbone.Model.extend({
		defaults: function() {
			return {
				id: null,
				pvName: null,
				label: "empty colour by label...",
			};
		}
	});

	app.ColourByList = Backbone.Collection.extend({
		model: app.ColorBy,
		localStorage = new Backbone.LocalStorage("app-colour-by"),
		comparator: 'order'
	});

	app.colourByList = new app.ColourByList();

	app.ColourByView = Backbone.View.extend({
		tagName: "option",

	});

	app.Chopping = Backbone.Model.extend({
		id: null,
		pdbId: null,
		title: '',
		domains: [],
		setChoppingFromCGIParams: function( opts ) {
			var param = this.parseCgiParam();
			console.log( "param: ", param );
			var domains = [];
			var chainId = param['id'];
			if ( !chainId ) {
				return undef;
			}
			var pdbId = chainId.substr(0, 4);
			var choppingStr = param['chopping' + chainId];
			var domains = this.parseChoppingString( choppingStr );

			this.set( { 'pdbId': pdbId, 'title': "DomChop: " + chainId, 'domains': domains } );

			return 1;
		},
		parseChoppingString: function(fullChoppingString) {
			
			var pdbCode  = fullChoppingString.substr(0, 4);
			var chopping = fullChoppingString.substr(5);
			var domainsAndFragments = chopping.split(' ');

			var segRegexp = /(-?[^\-]+)-(-?[^\[]+)\[(\S)\]/;  // 3-23[A] OR -5-123[B] OR 1(A)-234[C]
			var insertRegexp = /(-?\d+)\((\w)\)$/;

			var domains = [];

			var domainCount = 1;

			domainsAndFragments.forEach(function(domainStr) {
				var isDomain = domainStr.substr(0, 1) == 'D' ? 1 : 0,
					segmentStrings = domainStr.substr(1).split('+'),
					segments = [],
					chainCode;

				//console.log( "parseChoppingString.segmentStrings: ", segmentStrings );

				if ( isDomain ) {				
					segmentStrings.forEach(function(str) {
						var matches   = str.match( segRegexp );
						
						var start     = matches[1];
						var end       = matches[2];
						
						chainCode = matches[3];

						//console.log( "parseChoppingString.segmentString: ", str, matches );

						var m;
						if ( m = start.match( insertRegexp ) ) {
							start = m[1] + m[2];
						}
						if ( m = end.match( insertRegexp ) ) {
							end = m[1] + m[2];
						}

						segments.push({
							start:     start,
							end:       end,
							chainCode: chainCode,
						});
					});

					domains.push({ 
						id: pdbCode + chainCode + (domainCount < 10 ? '0' : '') + domainCount,
						color: domainColors[domainCount - 1],
						segments: segments,
					}); 

					domainCount++;
				}
			});
			
			return domains;
		},
		parseCgiParam: function() {
			var query = window.location.search.substring(1);
			var qs = query.split('+').join(' ');
			var params = {},
				tokens,
				re = /[?&]?([^=]+)=([^&]*)/g;

			while (tokens = re.exec(qs)) {
				params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);
			}

			return params;
		},
	});

	app.Choppings = Backbone.Collection.extend({
		model: app.Chopping,
		activeId: null,
		getActiveChopping: function() {
			return this.activeId !== null ? this.get( this.activeId ) : null;
		},
		setActive: function(id) {
			var ch = this.get(id);
			//console.log( "app.Choppings: setting active chopping: ", id, ch );
			if ( ch ) {
				this.activeId = ch.id;
			}
			else {
				console.error( "Failed to select chopping " + id + " (doesn't exist in choppings collection)" );
			}
			return ch;
		}
	});

	app.SelectColourBy = Backbone.View.extend({
		el: '#pv-select-colour',
		template: _.template(""),
		default: 'cartoon',
		// It's the first function called when this view it's instantiated.
		initialize: function(){
			this.$el.html( this.template( {} ));
		},

	});

	app.PdbView = Backbone.View.extend({
		el: '#pv-container',
		template: _.template(""),
		viewer: null,
		pdb: null,
		choppings: null,
		activeColourer: null,
		style: 'cartoon',
		// It's the first function called when this view it's instantiated.
		initialize: function(){
			this.$el.html( this.template( {} ));
			this.viewer = pv.Viewer( document.getElementById('viewer-container'), pvOpts );
			this.pdb = new app.Pdb();
			this.choppings = new app.Choppings();
			this.setActiveColourer( 'colourByChopping' );

			var cgiChopping = new app.Chopping({ 'id': 'cgi', 'title': 'DomChop' });

			if ( cgiChopping.setChoppingFromCGIParams() ) {
				var pdbId = cgiChopping.get('pdbId');

				var v = this.viewer;

				console.log( "cgiChopping", pdbId, cgiChopping, this.activeColourer );

				this.choppings.add( cgiChopping );

				this.choppings.setActive( cgiChopping );

				var self = this;

				this.pdb.load( pdbId, function(pvStructure) {
					v.centerOn( pvStructure );
					self.render();
				});
			}
			else {
				this.render();
			}
		},
		setActiveColourer: function(fname) {
			var func = this[fname];
			if ( typeof func === 'function' ) {
				this.activeColourer = func.bind(this);
			}
			else {
				console.error( "failed to setActiveColourer as " + fname + " (function does not exist: " + typeof func + ")" );
			}
		},
		getColourer: function() {
			return this.activeColourer;
		},
		setStyle: function(fname) {
			var func = this.viewer[fname];
			if ( typeof func === 'function' ) {
				this.style = fname;
			}
			else {
				console.error( "failed to setActiveStyler as " + fname + " (function does not exist: " + typeof func + ")" );
			}
		},
		getStyle: function() {
			return this.style;
		},
		styleView: function(name, view, options) {
			var style = this.getStyle();
			var styler = this.viewer[ style ];
			
			if ( typeof styler !== 'function' ) {
				console.error( "! Error: style '" + style + "' is not a valid method of PV Viewer", this.viewer );
				return null;
			}

			styler = styler.bind( this.viewer );

			if ( options ) {
				styler( name, view, options );
			}
			else {
				styler( name, view );
			}
		},
		render: function(){
			var v = this.viewer;

			v.clear();

			var colourer = this.getColourer();

			colourer();
		},
		colourByChopping: function() {
			console.log( "colourByChopping", this );
			var self = this;
			var v = this.viewer;
			var structure = this.pdb.get( 'pvStructure' );
			var chopping  = this.choppings.getActiveChopping();
			var domains   = chopping.get( 'domains' );

			domains.forEach( function(dom,domidx) {
				console.log( "dom", dom, domidx );
				var segs = dom.segments;
				segs.forEach( function(seg, segidx) {
					console.log( "seg", seg, segidx );
					var segView = structure.select( { chain: seg.chainCode, rnumRange: [seg.start, seg.end] } );
					var c = pv.color.uniform( dom.color );
					self.styleView( 'dom'+domidx+'seg'+segidx, segView, { color: c } );
				});
			});
		},
		colourBySS: function() {
			var self = this,
				v = this.viewer,
				structure = this.pdb.get('pvStructure');

			var c = pv.color.bySS();
			self.styleView( 'ss', structure, { color: c } );
		}
    });

	
	var pdbViewer = new app.PdbView();	

  </script>
  
</body>
</html>
